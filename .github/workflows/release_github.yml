# Release workflow for celq binaries
# Credit: Inspired by https://github.com/01mf02/jaq/blob/main/.github/workflows/release.yml
# Also see: https://github.com/BurntSushi/ripgrep/blob/61733f6378b62fa2dc2e7f3eff2f2e7182069ca9/.github/workflows/release.yml


name: GitHub Release

on:
  workflow_dispatch:  # Manual trigger only
  push:
    tags:
      - "v[0-9]*"      # Trigger on version tags like v1.0.0

defaults:
  run:
    shell: bash

env:
  NAME: celq
  VERSION: ${{ github.ref_name }}

# Required for gh release upload
permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    environment: github_release
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (native)
          - { target: aarch64-apple-darwin, os: macos-15 }
          
          # Windows x86-64 (native)
          - { target: x86_64-pc-windows-msvc, os: windows-2025 }
          
          # Linux x86-64 (native - glibc)
          - { target: x86_64-unknown-linux-gnu, os: ubuntu-24.04 }
          
          # Linux x86-64 (native - musl static binary)
          - { target: x86_64-unknown-linux-musl, os: ubuntu-24.04 }
          
          # Linux ARM64 (native)
          - { target: aarch64-unknown-linux-gnu, os: ubuntu-24.04-arm }

          # Linux ARM64 (native - musl static binary)
          - { target: aarch64-unknown-linux-musl, os: ubuntu-24.04-arm }

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools (for musl targets)
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Build
        run: cargo build --locked --release --target ${{ matrix.target }}

      - name: Create release archive
        id: archive
        run: |
          EXE_suffix="" 
          case ${{ matrix.target }} in 
            *-pc-windows-*) EXE_suffix=".exe" ;; 
          esac
          
          BIN_PATH="target/${{ matrix.target }}/release/${NAME}${EXE_suffix}"
          BIN_NAME="${NAME}${EXE_suffix}"
          
          # Determine archive format based on platform
          case ${{ matrix.target }} in
            *-pc-windows-*)
              # Windows: create .zip archive
              ARCHIVE_NAME="${NAME}-${{ matrix.target }}.zip"
              7z a "${ARCHIVE_NAME}" "${BIN_PATH}"
              ;;
            *)
              # Linux/macOS: create .tar.gz archive
              ARCHIVE_NAME="${NAME}-${{ matrix.target }}.tar.gz"
              tar czf "${ARCHIVE_NAME}" -C "target/${{ matrix.target }}/release" "${BIN_NAME}"
              ;;
          esac
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT

      - name: Upload release archive
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${VERSION} ${{ steps.archive.outputs.ARCHIVE_NAME }}